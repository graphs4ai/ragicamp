name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ============================================================================
  # FAST CHECKS (run in parallel, fail fast)
  # ============================================================================

  secrets-scan:
    name: Secret Scan (TruffleHog)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning all commits

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
  
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Check formatting (black)
        run: uv run black --check --diff src/ tests/ scripts/ --line-length 100

      - name: Check import sorting (isort)
        run: uv run isort --check-only --diff src/ tests/ scripts/ --profile black

      - name: Check types (mypy)
        run: uv run mypy src/ragicamp --ignore-missing-imports --no-error-summary || true
        # Note: mypy is informational for now

  import-check:
    name: Import Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install package
        run: uv sync

      - name: Test imports
        run: |
          uv run python -c "
          print('Testing imports...')
          
          # Core
          from ragicamp import ComponentFactory, ComponentRegistry
          print('✓ ragicamp core')
          
          # Core infrastructure
          from ragicamp.core import get_logger, RAGiCampError, AgentType
          print('✓ ragicamp.core')
          
          # Agents
          from ragicamp.agents import RAGAgent, DirectLLMAgent, FixedRAGAgent
          print('✓ ragicamp.agents')
          
          # Metrics
          from ragicamp.metrics import ExactMatchMetric, F1Metric
          print('✓ ragicamp.metrics')
          
          # Datasets
          from ragicamp.datasets import QADataset, QAExample
          print('✓ ragicamp.datasets')
          
          # Config
          from ragicamp.config import ConfigLoader, ExperimentConfig
          print('✓ ragicamp.config')
          
          print('✅ All imports successful!')
          "

  validate-configs:
    name: Validate Configs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync

      - name: Validate legacy configs
        run: |
          echo "Validating experiments/configs/*.yaml..."
          for config in experiments/configs/*.yaml; do
            echo "  → $config"
            uv run python scripts/utils/validate_config.py "$config"
          done

      - name: Validate Hydra configs
        run: |
          echo "Validating Hydra config structure..."
          uv run python -c "
          from omegaconf import OmegaConf
          import hydra
          from hydra import compose, initialize_config_dir
          from pathlib import Path
          import sys
          
          conf_dir = Path('conf').absolute()
          
          # Check main config exists
          if not (conf_dir / 'config.yaml').exists():
              print('❌ conf/config.yaml not found')
              sys.exit(1)
          
          # Check all subdirs have at least one yaml
          for subdir in ['model', 'dataset', 'agent', 'metrics', 'evaluation', 'prompt']:
              subpath = conf_dir / subdir
              if subpath.exists():
                  yamls = list(subpath.glob('*.yaml'))
                  print(f'✓ {subdir}/: {len(yamls)} configs')
              else:
                  print(f'⚠ {subdir}/ not found')
          
          # Try to load the default config
          try:
              with initialize_config_dir(version_base=None, config_dir=str(conf_dir)):
                  cfg = compose(config_name='config')
                  print(f'✓ Default config loads successfully')
                  print(f'  Model: {cfg.model.model_name}')
                  print(f'  Dataset: {cfg.dataset.name}')
          except Exception as e:
              print(f'❌ Failed to load config: {e}')
              sys.exit(1)
          
          print('✅ All Hydra configs valid!')
          "

  # ============================================================================
  # TESTS (run after fast checks pass)
  # ============================================================================
  
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: [lint, import-check]  # Only run if fast checks pass
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests with coverage
        run: |
          uv run pytest tests/ \
            -v \
            --tb=short \
            --cov=src/ragicamp \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=test-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml

      - name: Upload coverage to Codecov
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # FINAL STATUS CHECK
  # ============================================================================
  
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [secrets-scan, lint, import-check, validate-configs, test]
    if: always()
    
    steps:
      - name: Check all jobs
        run: |
          echo "Job Results:"
          echo "  Secrets Scan: ${{ needs.secrets-scan.result }}"
          echo "  Lint: ${{ needs.lint.result }}"
          echo "  Import Check: ${{ needs.import-check.result }}"
          echo "  Validate Configs: ${{ needs.validate-configs.result }}"
          echo "  Test: ${{ needs.test.result }}"
          echo ""
          
          # Fail if any required job failed
          if [ "${{ needs.secrets-scan.result }}" != "success" ]; then
            echo "❌ Secret scan failed - potential secrets detected!"
            exit 1
          fi
          
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Lint failed"
            exit 1
          fi
          
          if [ "${{ needs.import-check.result }}" != "success" ]; then
            echo "❌ Import check failed"
            exit 1
          fi
          
          if [ "${{ needs.validate-configs.result }}" != "success" ]; then
            echo "❌ Config validation failed"
            exit 1
          fi
          
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Tests failed"
            exit 1
          fi
          
          echo ""
          echo "✅ All CI checks passed!"
